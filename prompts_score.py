#!/usr/bin/env python3
# -*- coding: utf-8 -*-
from typing import Dict


def build_solver_user_prompt(writer_content: str, student_content: str, exercise_config: Dict) -> str:
    goals = (
        f"教育目标/约束:知识点={exercise_config['knowledge_point']};难度={exercise_config['difficulty']};"
        f"年级={exercise_config['grade']}{exercise_config['grade_level']};素养={exercise_config['core_competency']};"
        f"题型={exercise_config['exercise_type']}"
    )
    
    # 1. 角色设定
    prompt = (
        "你是一到九年级数学教育方面的专家。\n"
        "通用硬性规则：\n"
        "- 教育目标（年级/难度/知识点/核心素养）为固定约束，任何阶段不得建议或擅自修改\n"
        "- 严格遵守各函数指定的输出格式与字数要求;只输出要求的内容，不要额外解释\n"
        "- 中文回答，术语准确，逻辑清晰\n"
        "评分角色（Solver）规则：\n"
        "- 按指定维度与权重评分，并给出对应理由;禁止给学生提示\n"
        "- 若题型不符或答案明显错误，按规则降低或限制分数\n"
        "- 只输出评分模板要求的内容，且仅一个评分结果\n\n"
        "你的任务是对数学题目进行质量评分。\n\n"
    )

    # 2. RAG参考（暂无RAG内容）
    # prompt += ""

    # 3. 重要提示
    prompt += (
        "⚠️ 重要提示：\n"
        "- 只输出一个评分结果，不要输出多个评分或假设性评分\n"
        "- 修改建议仅基于上述评分维度与扣分理由，不得引入新标准\n"
        "- 不得建议调整年级/难度/知识点，不得给学生提示\n\n"
    )

    # 4. 输入信息（评分维度和题目内容）
    prompt += (
        "评分维度:\n"
        "- 逻辑完备性：条件是否充分，推理链是否自洽\n"
        "- 表述清晰度：题干是否容易被学生误解\n"
        "- 误区引导性：能否暴露常见错误，体现教学价值\n"
        "- 解法适切性：解法是否合理不过度繁琐\n"
        "- 题型符合性：题目形式是否与目标题型一致\n\n"
        "评分标准，并输出为什么打这个分数：\n"
        "1) 逻辑完备性（权重30%）:条件是否充分？推理链是否自洽？是否存在歧义/多解？\n"
        "   - 评分时请具体说明给分和扣分原因:题目条件是否完整、推理过程是否合理、是否存在多种解法或歧义\n"
        "2) 表述清晰度（权重20%）:题干是否容易被学生误解？\n"
        "   - 评分时请具体说明给分和扣分原因:语言表达是否清晰、是否存在容易误解的表述、术语使用是否准确\n"
        "3) 误区引导性（权重20%）:能否暴露/避免常见错误，体现教学价值？\n"
        "   - 评分时请具体说明给分和扣分原因:选项设计是否体现常见误区、是否有助于学生理解概念、教学价值如何\n"
        "4) 解法适切性（权重30%）:解法是否合理不过度繁琐？是否无需过多技巧/特殊方法？\n"
        "   - 评分时请具体说明给分和扣分原因:解题方法是否适合目标年级、计算复杂度是否合理、是否需要特殊技巧\n"
        "5) 题型符合性（0或1）:若生成题目形式与目标题型一致则为1，否则为0。\n"
        "   - 选择题：应包含清晰可辨的选项（如A/B/C/D）。\n"
        "   - 填空题：应包含空格/下划线等待填要素（如____）。\n"
        "   - 判断题：应为对/错型或等价二选一判断形式。\n"
        "   - 评分时请具体说明给分和扣分原因：题目格式是否符合目标题型要求\n\n"
        "强制核验：答案正确性（不计入权重，仅作为硬性约束）。若你能在不额外查找外部资料的前提下判定'题目给出的答案/标准答案'明显错误或与题干不一致，则将总分S限制为≤3，并在输出中给出理由。\n\n"
        "计算公式:S = 0.3×逻辑完备性 + 0.2×表述清晰度 + 0.2×误区引导性 + 0.3×解法适切性\n"
        "如果题型符合性=0，则直接判定S<6。\n\n"
        f"教育目标:{goals}\n\n"
        f"题目内容:{writer_content}\n\n"
        "输出格式严格如下（中文，简洁，控制在50-200字）：\n"
        "###评分:S=X.X分\n"
        "答案正确性:对/错 - [若判定为错，请简述理由;如无法确定，请写'无法确定']\n"
        "逻辑完备性：x.x（权重30%）- [具体评分理由]\n"
        "表述清晰度：x.x（权重20%）- [具体评分理由]\n"
        "误区引导性：x.x（权重20%）- [具体评分理由]\n"
        "解法适切性：x.x（权重30%）- [具体评分理由]\n"
        "题型符合性：0或1 - [具体评分理由]\n"
        "修改建议:仅基于上述评分维度与扣分理由提出2-3条可操作改进;逐条标注[对应维度/扣分点→具体改法→预期影响];建议应针对题干措辞、条件充分性、选项设计或解法适切性等具体问题;不得建议调整年级/难度/知识点;不得给学生提示;不得引入上述维度之外的新标准;\n"
        "⚠️ 题型约束:填空题不得建议增加选项，选择题不得建议改为填空题;修改建议必须符合目标题型特征。\n"
    )
    
    return prompt


def build_educator_user_prompt(writer_content: str, student_content: str, exercise_config: Dict) -> str:
    goals = (
        f"教育目标/约束:知识点={exercise_config['knowledge_point']};难度={exercise_config['difficulty']};"
        f"年级={exercise_config['grade']}{exercise_config['grade_level']};素养={exercise_config['core_competency']};"
        f"题型={exercise_config['exercise_type']}"
    )
    # 1. 角色设定
    prompt = (
        "你是一到九年级数学教育方面的专家。\n"
        "通用硬性规则：\n"
        "- 教育目标（年级/难度/知识点/核心素养）为固定约束，任何阶段不得建议或擅自修改\n"
        "- 严格遵守各函数指定的输出格式与字数要求;只输出要求的内容，不要额外解释\n"
        "- 中文回答，术语准确，逻辑清晰\n"
        "评分角色（Educator）规则：\n"
        "- 先明确目标难度与你的实际判断，再按规则给分；禁止建议修改年级/知识点\n"
        "- 只输出评分模板要求的内容，且仅一个评分结果\n\n"
        "你的任务是对数学题目进行教育价值评估。\n\n"
    )

    # 2. RAG参考（暂无RAG内容）
    # prompt += ""

    # 3. 重要提示
    prompt += (
        "⚠️ 重要提示：\n"
        "- 只输出一个评分结果，不要输出多个评分或假设性评分\n"
        "- 修改建议仅基于上述评分维度与扣分理由，不得引入新标准\n"
        "- 不得建议调整年级/难度/知识点，不得给学生提示\n\n"
    )

    # 4. 输入信息（评分维度和题目内容）
    prompt += (
        "评分维度:\n"
        "- 知识点契合度：是否准确覆盖目标知识点\n"
        "- 难度匹配度：难度是否与年级和教学目标匹配\n"
        "- 核心素养体现度：是否有效体现目标核心素养\n"
        "- 教学组织适切性：题型和教学组织是否恰当\n\n"
        "评分标准:\n"
        "1) 知识点契合度（权重25%）:是否准确覆盖目标知识点？\n"
        "   - 评分时请具体说明给分和扣分原因:题目是否准确考查了目标知识点、知识点覆盖是否全面、是否偏离了核心内容\n"
        "2) 难度匹配度（权重25%）:难度是否与年级和教学目标中需求的难度匹配？\n"
        f"   - 评分时请具体说明给分和扣分原因:先明确目标难度=[{exercise_config['difficulty']}];你的判断=[实际难度];依据包括:解题步数、抽象程度、是否多步骤/综合知识点、是否需要策略选择等。\n"
        "   - 分数规则（难度匹配必须严格按照这个给分，也就是这一项，只有10 5 2 1这几个分数）:若实际难度等于目标一档，本项=10;若实际难度低于目标一档（例:目标=难，实际=中），本项=5;低于两档（例:目标=难，实际=易），本项=2;高于目标一档（例:目标=中，实际=难），本项=5;无法判断给1并说明依据。\n"
        "\n"
        "3) 核心素养体现度（权重25%）:是否有效体现目标核心素养？\n"
        "   - 评分时请具体说明给分和扣分原因:题目是否体现了数学抽象、逻辑推理、数学运算、直观想象、数据分析等核心素养\n"
        "4) 教学组织适切性（权重25%）:题型和教学组织是否恰当？\n"
        "   - 评分时请具体说明给分和扣分原因：题型选择是否合适、题目结构是否合理、是否符合教学规律\n\n"
        "计算公式:E = 0.25×知识点契合度 + 0.25×难度匹配度 + 0.25×核心素养体现度 + 0.25×教学组织适切性\n\n"
        f"教育目标:{goals}\n\n"
        f"题目内容:{writer_content}\n\n"
        "输出格式严格如下（中文，简洁，控制在50-200字）：\n"
        "###教育评分:E=X.X分\n"
        "知识点契合度：x.x（权重25%）- [具体评分理由]\n"
        "难度匹配度：x.x（权重25%）- [具体评分理由]\n"
        "核心素养体现度：x.x（权重25%）- [具体评分理由]\n"
        "教学组织适切性：x.x（权重25%）- [具体评分理由]\n"
        "修改建议:仅基于上述评分维度与扣分理由提出2-3条可操作改进;逐条标注[对应维度/扣分点→具体改法→预期影响];仅当你已在'难度匹配度'中明确判定难度不匹配且给出理由时，方可建议'调整难度';若难度匹配，请不要讨论或建议调整难度;禁止建议调整年级或知识点;不要给出学生提示;不得引入上述维度之外的新标准。\n"
    )
    
    return prompt


